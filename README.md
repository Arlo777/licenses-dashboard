# DauArlo

CI/CD –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Kubernetes
–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (CI/CD) –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è NGINX –≤ –∫–ª–∞—Å—Ç–µ—Ä Kubernetes —Å –ø–æ–º–æ—â—å—é GitLab.

–ü–∞–π–ø–ª–∞–π–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

–°–æ–±–∏—Ä–∞–µ—Ç Docker-–æ–±—Ä–∞–∑ —Å –≤–∞—à–∏–º —Å–∞–π—Ç–æ–º.

–ó–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ –≤ GitLab Container Registry.

–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Kubernetes.

‚öôÔ∏è –ß—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞
–î–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É Kubernetes.

–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π kubectl –Ω–∞ –≤–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Ingress-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, NGINX Ingress).

–ü—Ä–æ–µ–∫—Ç –≤ GitLab (–∫—É–¥–∞ –≤—ã –∑–∞–≥—Ä—É–∑–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥).

–î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –≤–∞—à —Å–∞–π—Ç.

üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞
–ß—Ç–æ–±—ã –ø–∞–π–ø–ª–∞–π–Ω –∑–∞—Ä–∞–±–æ—Ç–∞–ª, –Ω—É–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É GitLab –∏ –≤–∞—à–∏–º –∫–ª–∞—Å—Ç–µ—Ä–æ–º Kubernetes.

–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Kubernetes
–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å (ServiceAccount) –¥–ª—è GitLab –∏ –¥–∞–¥–∏–º –µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞.

–°–æ–∑–¥–∞–π—Ç–µ ServiceAccount, Role –∏ RoleBinding.
–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

Bash

cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitlab-ci-sa
  namespace: default
---
apiVersion: rbac.authorization.k —Ä–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç–∏ v1
kind: Role
metadata:
  name: gitlab-ci-role
  namespace: default
rules:
- apiGroups: ["", "apps", "networking.k8s.io"]
  resources: ["deployments", "services", "pods", "ingresses"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gitlab-ci-binding
  namespace: default
subjects:
- kind: ServiceAccount
  name: gitlab-ci-sa
  namespace: default
roleRef:
  kind: Role
  name: gitlab-ci-role
  apiGroup: rbac.authorization.k8s.io
EOF
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è GitLab.
–≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–∞–π–ø–ª–∞–π–Ω–æ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É.

Bash

kubectl create token gitlab-ci-sa -n default --duration=8760h
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω, –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ.

–®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ GitLab
–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É –≤ GitLab –≤ –≤–∏–¥–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

–í –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ GitLab –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Settings ‚Üí CI/CD.

–ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª Variables –∏ –Ω–∞–∂–º–∏—Ç–µ Expand.

–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

Key	Value	Protected	Masked
KUBE_SERVER	URL –≤–∞—à–µ–≥–æ Kubernetes API-—Å–µ—Ä–≤–µ—Ä–∞	–î–∞	–î–∞
KUBE_CA_DATA	–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ (Base64)	–î–∞	–î–∞
KUBE_TOKEN	–¢–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞ –®–∞–≥–µ 1	–î–∞	–î–∞
APP_HOST	–í–∞—à–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, arlanito.kz)	–î–∞	–ù–µ—Ç

Export to Sheets
–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å KUBE_SERVER –∏ KUBE_CA_DATA?
–í—ã–ø–æ–ª–Ω–∏—Ç–µ kubectl config view --minify –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, –∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ –∏—Ö –≤ –≤—ã–≤–æ–¥–µ.

–®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è (APP_HOST) —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–Ω–µ—à–Ω–∏–π IP-–∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ Ingress-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞.

–£–∑–Ω–∞–π—Ç–µ IP-–∞–¥—Ä–µ—Å –∫–æ–º–∞–Ω–¥–æ–π: kubectl get svc -n ingress-nginx

–°–æ–∑–¥–∞–π—Ç–µ A-–∑–∞–ø–∏—Å—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞, —É–∫–∞–∑—ã–≤–∞—é—â—É—é –Ω–∞ —ç—Ç–æ—Ç IP.

üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
–ö–æ–º–º–∏—Ç –≤ main: –õ—é–±–æ–π git push –≤ –≤–µ—Ç–∫—É main –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω.

–≠—Ç–∞–ø build:

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç Dockerfile.

–°–æ–±–∏—Ä–∞–µ—Ç—Å—è Docker-–æ–±—Ä–∞–∑, –≤ –∫–æ—Ç–æ—Ä—ã–π –∫–æ–ø–∏—Ä—É—é—Ç—Å—è —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ html/.

–ì–æ—Ç–æ–≤—ã–π –æ–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ GitLab Container Registry, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –≤–∞—à–µ–º—É –ø—Ä–æ–µ–∫—Ç—É.

–≠—Ç–∞–ø deploy:

–ó–∞–¥–∞—á–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –≤–∞—à–µ–º—É Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä—É, –∏—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏.

–û–Ω–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ –ø–∞–ø–∫–∏ kubernetes/, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è –≤ –Ω–∏—Ö –Ω—É–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–º—è –æ–±—Ä–∞–∑–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ –∏ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è).

–ö–æ–º–∞–Ω–¥–∞ kubectl rollout status –¥–æ–∂–∏–¥–∞–µ—Ç—Å—è, –ø–æ–∫–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±—É–¥–µ—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞.

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–∞—à —Å–∞–π—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –¥–æ–º–µ–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏.

üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

.
‚îú‚îÄ‚îÄ .gitlab-ci.yml      # –§–∞–π–ª –ø–∞–π–ø–ª–∞–π–Ω–∞
‚îú‚îÄ‚îÄ Dockerfile          # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker-–æ–±—Ä–∞–∑–∞
‚îú‚îÄ‚îÄ html/               # –ü–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îî‚îÄ‚îÄ kubernetes/         # –ü–∞–ø–∫–∞ —Å –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞–º–∏ Kubernetes
    ‚îú‚îÄ‚îÄ deployment.yaml
    ‚îú‚îÄ‚îÄ service.yaml
    ‚îî‚îÄ‚îÄ ingress.yaml
